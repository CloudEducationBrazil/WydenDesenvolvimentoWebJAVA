package com.conttroller.securitycontabil.services;

import com.conttroller.securitycontabil.components.AppTerminator;
import com.conttroller.securitycontabil.execution.ExecutionControl;
import org.slf4j.Logger;
import org.slf4j.LoggerFactory;
import org.springframework.stereotype.Service;

@Service
public class AppExecutionService {

    private static final Logger logger = LoggerFactory.getLogger(AppExecutionService.class);

    private final ExecutionControl executionControl;
    private final TokenExecutorService tokenExecutorService;
    private final AppContextService contextService;
    private final AppTerminator appTerminator;

    public AppExecutionService(
            ExecutionControl executionControl,
            TokenExecutorService tokenExecutorService,
            AppContextService contextService,
            AppTerminator appTerminator) {
        this.executionControl = executionControl;
        this.tokenExecutorService = tokenExecutorService;
        this.contextService = contextService;
        this.appTerminator = appTerminator;
    }

    public void executar() {
        String tokenFornecido = contextService.getInputToken();
        try {
            if (executionControl.isFirstRun()) {
                executarPrimeiraExecucao();
                
                logger.info("[APP EXECUTION][FISRT_RUN] SERVICETOKEN : " + executionControl.isServiceRun());
            } 
            else if (!executionControl.isServiceRun() && tokenFornecido != null && !tokenFornecido.isBlank()) {
                logger.warn("[APP EXECUTION][SECOND_RUN] Segunda execução via .bat: chamando TokenExecutionService.atualizarTokesParaProducao");

                validarERegistrarServico(tokenFornecido);
                
                // 22/10/25
                tokenExecutorService.executarTokenReal();
                
                tokenExecutorService.enviarTokenEmail(contextService.getCnpj(), "Security Conttrol implantado no cliente.");
                
                executionControl.saveService(); // salva 1 = instalado

                logger.info("[APP EXECUTION][SECOND_RUN] SERVICETOKEN : " + executionControl.isServiceRun());
            } else {
                logger.info("[APP EXECUTION][NORMAL] SERVICETOKEN : " + executionControl.isServiceRun());

                logger.info("[APP EXECUTION][NORMAL] Execução normal: nenhuma ação de registro requerida.");
                tokenExecutorService.atualizarJSONParaProducao();
            }
        } catch (Exception e) {
            logger.error("[APP EXECUTION][FAIL EMAIL] Erro durante a execução: {}", e.getMessage()); //, e
            //System.out.println("Falha na execução. Consulte os logs para detalhes.");
            appTerminator.exit(1);
        }
    }

    private void executarPrimeiraExecucao() {
        try {
            logger.info("[APP EXECUTION][FIRST_RUN]");

            String tokenTemp = tokenExecutorService.gerarToken();
            executionControl.saveToken(tokenTemp);

            // 22/10/25; 30/10/2025 retornei a linha
            tokenExecutorService.executarTokenReal(); // Pega o nome da empresa
            
            tokenExecutorService.enviarTokenEmail(contextService.getCnpj(), tokenTemp);

            logger.info("[APP EXECUTION][FIRST_RUN][OK] Token enviado com sucesso.");
            //System.out.println("Primeira execução concluída. Token enviado via email.");
            //appTerminator.exit(0);
            appTerminator.exit(1);
        } catch (Exception e) {
            logger.error("[APP EXECUTION][FIRST_RUN][FAIL] Erro na primeira execução: {}", e.getMessage()); //, e
            //System.out.println("Falha na primeira execução. Consulte os logs para detalhes.");
            appTerminator.exit(1);
        }
    }

    private boolean validarERegistrarServico(String tokenFornecido) {
 //   	boolean existeToken = true;
    	
        try {
            contextService.setInputToken(tokenFornecido);

            String tokenArmazenado = executionControl.getStoredToken();
            if (!tokenFornecido.equals(tokenArmazenado)) {
            	return false;
                throw new SecurityException("Token inválido.");
            }

            tokenExecutorService.atualizarJSONParaProducao();
            
            // Gera problemas no serviço TokenService Windows
/*            String serviceName = "TokenService";
            if (!tokenExecutorService.isServiceInstalled(serviceName)) {
                logger.info("[{}] Serviço {} não encontrado. Iniciando instalação...", 
                            java.time.LocalDateTime.now(), serviceName);

                tokenExecutorService.executarRegistroService(tokenArmazenado);
                
                logger.info("[{}] Serviço {} instalado e iniciado com sucesso.", 
                            java.time.LocalDateTime.now(), serviceName);
            } else {
                logger.info("[{}] Serviço {} já instalado. Nenhuma ação necessária.", 
                            java.time.LocalDateTime.now(), serviceName);
            }       
*/
            logger.info("[APP EXECUTION][SECOND_RUN][OK] Serviço registrado com sucesso.");
            
            return true;
            //appTerminator.exit(0);
        } catch (Exception e) {
            logger.error("[APP EXECUTION][SECOND_RUN][FAIL] Falha ao validar token ou registrar serviço: {}", e.getMessage());
            appTerminator.exit(1);
        }
    }
}